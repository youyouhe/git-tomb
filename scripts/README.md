# Supabase Setup Guide

This document explains how to set up the Supabase database for Repo Graveyard with anonymous respects support.

## Quick Setup

### 1. Run the Initialization Script

In Supabase SQL Editor, run the complete initialization script:

```bash
# Run the full initialization
scripts/supabase-init.sql
```

This will create:
- `user_profiles` table for authenticated users
- `user_rate_limits` table for rate limiting
- `graveyards` table for buried projects
- `priest_stats` table for AI priest statistics
- RLS policies for security
- Triggers and functions

### 2. Enable Anonymous Respects

After the initial setup, run the anonymous respects script:

```bash
# Allow anonymous users to pay respects with nickname tracking
scripts/allow-anon-respects-simple.sql
```

This creates:
- `respects_log` table to track who paid respects (for anti-spam)
- Updated `increment_respects` function that accepts mourner names

## What Changes Were Made?

### For Anonymous Respects

**Before**: Only authenticated users could pay respects.

**After**: Anyone can pay respects, and it records the mourner's name (nickname for anonymous users, GitHub username for authenticated users).

### Key Database Changes

1. **respects_log table**:
   - `grave_id`: Which grave was respected
   - `mourner_name`: Nickname or GitHub username
   - `mourner_id`: User ID (NULL for anonymous)
   - `created_at`: When the respect was paid
   - Purpose: Track respects for rate limiting and anti-spam

2. **increment_respects function**:
   - Now accepts `mourner_name` parameter
   - Records each respect in the log
   - No authentication required

## User Flow

1. **Anonymous User**:
   - Gets a random nickname (e.g., "SilentDigger#1234")
   - Can pay respects to any grave
   - Can change nickname in Identity settings

2. **Authenticated User (GitHub)**:
   - Uses their GitHub username
   - Can pay respects and bury projects
   - Appears in "Top Undertakers" leaderboard (based on burials)

## Leaderboards

There are two leaderboards:

1. **Top Undertakers**: Based on number of projects buried
2. **Priest Stats**: Based on eulogies generated by each AI

## Permissions Summary

| Action | Anonymous | Authenticated |
|--------|-----------|---------------|
| View graves | ✅ | ✅ |
| Pay respects | ✅ | ✅ |
| View leaderboards | ✅ | ✅ |
| Bury project | ❌ | ✅ |
| Bless priest | ❌ | ✅ |

## Troubleshooting

### Error: "function increment_respects(uuid, text) does not exist"

Run the `allow-anon-respects-simple.sql` script to create the updated function.

### Error: "permission denied for function increment_respects"

Make sure you granted execute permissions:
```sql
GRANT EXECUTE ON FUNCTION increment_respects(UUID, TEXT) TO authenticated;
GRANT EXECUTE ON FUNCTION increment_respects(UUID, TEXT) TO anon;
```
